serviceAccount:
  create: true
  name: fluent-bit

rbac:
  create: true

daemonSetVolumes:
  - name: varlog
    hostPath:
      path: /var/log

daemonSetVolumeMounts:
  - name: varlog
    mountPath: /var/log

config:
  filters: |
    # Attach Kubernetes metadata
    [FILTER]
        Name kubernetes
        Match kube.*
        Merge_Log On
        Keep_Log Off
        Labels On
        Annotations Off

    # ONLY logs from default namespace
    [FILTER]
        Name grep
        Match kube.*
        Regex kubernetes['namespace_name'] ^default$

    # Normalize fields
    [FILTER]
        Name modify
        Match kube.*
        Rename kubernetes['namespace_name'] namespace
        Rename kubernetes['pod_name'] pod
        Rename kubernetes['container_name'] container

    # Add node name
    [FILTER]
        Name modify
        Match kube.*
        Add node ${HOSTNAME}

  outputs: |
    [OUTPUT]
        Name file
        Match kube.*
        Path /var/log/cluster-logs/
        File default.log

    [OUTPUT]
        Name        loki
        Match       kube.*
        Host        loki.monitoring.svc.cluster.local
        Port        3100
        Auto_Kubernetes_Labels on

# config:
#   service: |
#     [SERVICE]
#         Flush        1
#         Daemon       Off
#         Log_Level    info

#   inputs: |
#     [INPUT]
#         Name              tail
#         Path              /var/log/containers/*.log
#         multiline.parser docker, cri
#         Tag kube.*
#         Refresh_Interval  5
#         Rotate_Wait       30
#         Mem_Buf_Limit     10MB
#         Skip_Long_Lines   On
#         DB                /var/log/flb_kube.db

#     [INPUT]
#         Name systemd
#         Tag host.*
#         Systemd_Filter _SYSTEMD_UNIT=kubelet.service
#         Read_From_Tail On

#   filters: |
#     # Attach Kubernetes metadata
#     [FILTER]
#         Name                kubernetes
#         Match               kube.*
#         Kube_Tag_Prefix     kube.var.log.containers.
#         Merge_Log           Off
#         Keep_Log            On
#         Labels              On
#         Annotations         Off

#     # Set service_name from app label if present
#     [FILTER]
#         Name    modify
#         Match   kube.*
#         Copy    kubernetes['labels']['app.kubernetes.io/name'] service_name

#     # Fallback: use container name if no app label
#     [FILTER]
#         Name    modify
#         Match   kube.*
#         Copy    kubernetes['container_name'] service_name

#     # Normalize field names
#     [FILTER]
#         Name    modify
#         Match   kube.*
#         Rename  kubernetes['namespace_name'] namespace
#         Rename  kubernetes['pod_name'] k8s_pod_name

#   outputs: |
#     [OUTPUT]
#         Name        loki
#         Match       kube.*
#         Host        loki-gateway.monitoring.svc.cluster.local
#         Port        3100
#         # Only the labels you asked for:
#         Labels      namespace=$namespace,k8s_pod_name=$k8s_pod_name,service_name=$service_name
#         Auto_Kubernetes_Labels off
